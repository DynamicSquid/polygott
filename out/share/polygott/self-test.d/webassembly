#!/bin/bash

set -e

CODE=0

if [[ -n "${LANGS}" && ",${LANGS}," != *",webassembly,"* ]]; then
	echo S 'WebAssembly:*'
	exit $CODE
fi

find /home/runner -mindepth 1 -maxdepth 1 -exec rm -rf {} \;
polygott-lang-setup -l 'webassembly'

# WebAssembly:hello
SUCCESS=true
OUTPUT="$(echo 'Ozsgd2F0Mndhc20gbWFpbi53YXQNCg0KKG1vZHVsZSAkaGVsbG8NCiAgICA7OyBJbXBvcnQgdGhlIHJlcXVpcmVkIGZkX3dyaXRlIFdBU0kgZnVuY3Rpb24gd2hpY2ggd2lsbCB3cml0ZSB0aGUgZ2l2ZW4gaW8gdmVjdG9ycyB0byBzdGRvdXQNCiAgICA7OyBUaGUgZnVuY3Rpb24gc2lnbmF0dXJlIGZvciBmZF93cml0ZSBpczoNCiAgICA7OyAoRmlsZSBEZXNjcmlwdG9yLCAqaW92cywgaW92c19sZW4sIG53cml0dGVuKSAtPiBSZXR1cm5zIG51bWJlciBvZiBieXRlcyB3cml0dGVuDQogICAgKGltcG9ydCAid2FzaV91bnN0YWJsZSIgImZkX3dyaXRlIg0KICAgICAgICAoZnVuYyAkZmRfd3JpdGUgKHBhcmFtIGkzMiBpMzIgaTMyIGkzMikgKHJlc3VsdCBpMzIpKQ0KICAgICkNCg0KICAgIChtZW1vcnkgMSkNCiAgICAoZXhwb3J0ICJtZW1vcnkiIChtZW1vcnkgMCkpDQoNCiAgICA7OyBXcml0ZSAnaGVsbG8gd29ybGRcbicgdG8gbWVtb3J5IGF0IGFuIG9mZnNldCBvZiA4IGJ5dGVzDQogICAgOzsgTm90ZSB0aGUgdHJhaWxpbmcgbmV3bGluZSB3aGljaCBpcyByZXF1aXJlZCBmb3IgdGhlIHRleHQgdG8gYXBwZWFyDQogICAgKGRhdGEgKGkzMi5jb25zdCA4KSAiSGVsbG8sIFdvcmxkIikNCg0KICAgIChmdW5jICRtYWluIChleHBvcnQgIl9zdGFydCIpDQogICAgICAgIDs7IENyZWF0aW5nIGEgbmV3IGlvIHZlY3RvciB3aXRoaW4gbGluZWFyIG1lbW9yeQ0KICAgICAgICAoaTMyLnN0b3JlIChpMzIuY29uc3QgMCkgKGkzMi5jb25zdCA4KSkgIDs7IGlvdi5pb3ZfYmFzZSAtIFRoaXMgaXMgYSBwb2ludGVyIHRvIHRoZSBzdGFydCBvZiB0aGUgJ2hlbGxvIHdvcmxkXG4nIHN0cmluZw0KICAgICAgICAoaTMyLnN0b3JlIChpMzIuY29uc3QgNCkgKGkzMi5jb25zdCAxMikpICA7OyBpb3YuaW92X2xlbiAtIFRoZSBsZW5ndGggb2YgdGhlICdoZWxsbyB3b3JsZFxuJyBzdHJpbmcNCg0KICAgICAgICAoY2FsbCAkZmRfd3JpdGUNCiAgICAgICAgICAgIChpMzIuY29uc3QgMSkgOzsgZmlsZV9kZXNjcmlwdG9yIC0gMSBmb3Igc3Rkb3V0DQogICAgICAgICAgICAoaTMyLmNvbnN0IDApIDs7ICppb3ZzIC0gVGhlIHBvaW50ZXIgdG8gdGhlIGlvdiBhcnJheSwgd2hpY2ggaXMgc3RvcmVkIGF0IG1lbW9yeSBsb2NhdGlvbiAwDQogICAgICAgICAgICAoaTMyLmNvbnN0IDEpIDs7IGlvdnNfbGVuIC0gV2UncmUgcHJpbnRpbmcgMSBzdHJpbmcgc3RvcmVkIGluIGFuIGlvdiAtIHNvIG9uZS4NCiAgICAgICAgICAgIChpMzIuY29uc3QgMjApIDs7IG53cml0dGVuIC0gQSBwbGFjZSBpbiBtZW1vcnkgdG8gc3RvcmUgdGhlIG51bWJlciBvZiBieXRlcyB3cml0ZW4NCiAgICAgICAgKQ0KICAgICAgICBkcm9wIDs7IERpc2NhcmQgdGhlIG51bWJlciBvZiBieXRlcyB3cml0dGVuIGZyb20gdGhlIHRvcCB0aGUgc3RhY2sNCiAgICApDQopDQo=' | \
          base64 --decode | \
          run-project -s -l 'webassembly' \
       )" || SUCCESS=false
if [[ "${SUCCESS}" == "true" ]]; then
  echo "${OUTPUT}" | \
    diff --unified --ignore-trailing-space --label 'WebAssembly' \
      <( echo 'SGVsbG8sIFdvcmxk' | base64 --decode ) \
      - || \
  SUCCESS=false
else
  echo "run failed: \"${OUTPUT}\", exit code $?" >&2
fi

if [[ "${SUCCESS}" == "true" ]]; then
  echo ✓ 'WebAssembly:hello'
else
  echo ❌ 'WebAssembly:hello'
  CODE=1
fi

exit $CODE
